<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Precision Mozzarella Toss Challenge</title>
    <style>
        body { margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #f0f0f0; }
    </style>
</head>
<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.55.2/phaser.min.js"></script>
    <script>
    const config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        physics: {
            default: 'arcade',
            arcade: { gravity: { y: 300 }, debug: false }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };

    const game = new Phaser.Game(config);
    let player, cousin, mozzarella, ferry, boat;
    let score = 0;
    let level = 1;
    let scoreText, levelText, instructionText;
    let gameState = 'playing';
    let ferrySpeed = 0.5;
    let wind = 0;
    let levelCompleteText;
    let powerMeter;
    let powerText;
    let isPoweringUp = false;
    let power = 0;

    function preload() {
        this.load.image('background', 'background.png');
        this.load.image('ferry', 'ferry.png');
        this.load.image('player', 'player.png');
        this.load.image('cousin', 'cousin.png');
        this.load.image('mozzarella', 'mozzarella.png');
        this.load.image('boat', 'boat.png'); // Make sure to create a small boat image
    }

    function create() {
        this.add.image(400, 300, 'background');
        
        ferry = this.add.image(200, 400, 'ferry');

        player = this.add.sprite(ferry.x - ferry.width/2 + 50, ferry.y - 10, 'player');
        player.setScale(0.5);

        cousin = this.add.sprite(100, 525, 'cousin');
        cousin.setScale(0.5);

        // Add a separate boat sprite for more precise collision
        boat = this.physics.add.sprite(100, 540, 'boat');
        boat.setScale(0.5);
        boat.setSize(50, 20); // Adjust the collision box size

        mozzarella = this.physics.add.sprite(player.x, player.y, 'mozzarella');
        mozzarella.setVisible(false);
        mozzarella.setCircle(10); // Assuming mozzarella is roughly circular

        scoreText = this.add.text(16, 16, 'Score: 0', { fontSize: '32px', fill: '#000' });
        levelText = this.add.text(16, 56, 'Level: 1', { fontSize: '32px', fill: '#000' });
        instructionText = this.add.text(400, 100, 'Click and hold to power up, release to throw!', { fontSize: '24px', fill: '#000' }).setOrigin(0.5);

        powerMeter = this.add.rectangle(player.x, player.y - 50, 100, 10, 0xff0000);
        powerMeter.setOrigin(0, 0.5);
        powerMeter.setVisible(false);

        powerText = this.add.text(player.x, player.y - 70, 'Power: 0%', { fontSize: '16px', fill: '#000' });
        powerText.setOrigin(0.5);
        powerText.setVisible(false);

        this.input.on('pointerdown', startPowerUp);
        this.input.on('pointerup', throwMozzarella);

        this.physics.add.overlap(mozzarella, boat, hitBoat, null, this);
    }

    function update() {
        if (gameState !== 'playing') return;

        ferry.x += ferrySpeed;
        player.x += ferrySpeed;
        powerMeter.x += ferrySpeed;
        powerText.x += ferrySpeed;

        if (isPoweringUp) {
            power = (power + 1) % 100;
            updatePowerMeter();
        }

        if (mozzarella.visible) {
            mozzarella.x += wind;
            if (mozzarella.y > 600 || mozzarella.x < 0 || mozzarella.x > 800) {
                resetMozzarella();
            }
        }

        if (ferry.x - ferry.width/2 > 800) {
            gameOver();
        }
    }

    function startPowerUp() {
        if (gameState !== 'playing') return;
        isPoweringUp = true;
        power = 0;
        powerMeter.setVisible(true);
        powerText.setVisible(true);
    }

    function updatePowerMeter() {
        powerMeter.width = power;
        powerText.setText(`Power: ${power}%`);
    }

    function throwMozzarella() {
        if (gameState !== 'playing' || !isPoweringUp) return;

        isPoweringUp = false;
        powerMeter.setVisible(false);
        powerText.setVisible(false);

        mozzarella.setVisible(true);
        mozzarella.setPosition(player.x, player.y);
        
        let angle = Phaser.Math.Angle.Between(player.x, player.y, boat.x, boat.y);
        
        let throwSpeed = 200 + (power * 3);
        
        let velocityX = Math.cos(angle) * throwSpeed;
        let velocityY = Math.sin(angle) * throwSpeed - 150;
        
        velocityX += Phaser.Math.Between(-20, 20);
        velocityY += Phaser.Math.Between(-20, 20);
        
        mozzarella.setVelocity(velocityX, velocityY);
    }

    function hitBoat(mozzarella, boat) {
        if (mozzarella.body.velocity.y > 0) { // Only count if mozzarella is falling down
            mozzarella.setVelocity(0, 0);
            mozzarella.setY(boat.y - boat.height/2);
            this.time.delayedCall(500, () => { // Delay to show mozzarella in the boat
                levelComplete.call(this);
            });
        }
    }

    function levelComplete() {
        resetMozzarella();
        score += 10;
        scoreText.setText('Score: ' + score);
        
        gameState = 'levelComplete';
        levelCompleteText = this.add.text(400, 300, 'Level Complete!', { fontSize: '64px', fill: '#000' }).setOrigin(0.5);
        
        this.time.delayedCall(2000, () => {
            levelCompleteText.destroy();
            nextLevel.call(this);
        });
    }

    function nextLevel() {
        level++;
        levelText.setText('Level: ' + level);
        
        ferrySpeed += 0.1;
        wind = Phaser.Math.Between(-2, 2);

        ferry.x = 200;
        player.x = ferry.x - ferry.width/2 + 50;
        powerMeter.x = player.x;
        powerText.x = player.x;

        let newBoatX = Math.min(100 + (level * 15), 650);
        boat.x = newBoatX;
        cousin.x = newBoatX;
        
        gameState = 'playing';
    }

    function resetMozzarella() {
        mozzarella.setVisible(false);
        mozzarella.setPosition(player.x, player.y);
        mozzarella.setVelocity(0, 0);
    }

    function gameOver() {
        gameState = 'gameOver';
        this.add.text(400, 300, 'Game Over', { fontSize: '64px', fill: '#000' }).setOrigin(0.5);
        this.time.delayedCall(3000, () => {
            location.reload();
        });
    }
    </script>
</body>
</html>
