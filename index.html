<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mozzarella Toss Challenge</title>
    <style>
        body { margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #f0f0f0; }
    </style>
</head>
<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.55.2/phaser.min.js"></script>
    <script>
    class GameScene extends Phaser.Scene {
        constructor() {
            super('GameScene');
        }

        preload() {
            this.load.image('background', 'background.png');
            this.load.image('ferry', 'ferry.png');
            this.load.spritesheet('arm', 'arm_spritesheet.png', { frameWidth: 100, frameHeight: 200 });
            this.load.image('cousin', 'cousin.png');
            this.load.image('mozzarella', 'mozzarella.png');
        }

        create() {
            this.add.image(400, 300, 'background');
            this.showTitleScreen();
        }

        showTitleScreen() {
            this.titleText = this.add.text(400, 200, 'Mozzarella Toss Challenge', { fontSize: '32px', fill: '#000' }).setOrigin(0.5);
            this.startButton = this.add.text(400, 300, 'Start Game', { fontSize: '24px', fill: '#000' })
                .setOrigin(0.5)
                .setInteractive()
                .on('pointerdown', () => this.showInstructions());
        }

        showInstructions() {
            this.titleText.destroy();
            this.startButton.destroy();

            this.instructionsText = this.add.text(400, 200, 
                "Your cousin needs mozzarella!\nYou're on the ferry pulling away.\nGet it to him before it's too late!", 
                { fontSize: '24px', fill: '#000', align: 'center' }
            ).setOrigin(0.5);

            this.continueButton = this.add.text(400, 400, 'Continue', { fontSize: '24px', fill: '#000' })
                .setOrigin(0.5)
                .setInteractive()
                .on('pointerdown', () => this.startGame());
        }

        startGame() {
            if (this.instructionsText) this.instructionsText.destroy();
            if (this.continueButton) this.continueButton.destroy();

            this.ferry = this.add.image(200, 400, 'ferry');
            this.arm = this.add.sprite(this.ferry.x - this.ferry.width/2 + 50, this.ferry.y - 10, 'arm').setScale(0.5);
            this.cousin = this.physics.add.staticImage(100, 525, 'cousin').setScale(1);
            this.mozzarella = this.physics.add.sprite(this.arm.x, this.arm.y, 'mozzarella').setVisible(false);

            this.anims.create({
                key: 'throw',
                frames: this.anims.generateFrameNumbers('arm', { start: 0, end: 2 }),
                frameRate: 10,
                repeat: 0
            });

            this.scoreText = this.add.text(16, 16, 'Score: 0', { fontSize: '32px', fill: '#000' });
            this.levelText = this.add.text(16, 56, 'Level: 1', { fontSize: '32px', fill: '#000' });
            this.instructionText = this.add.text(400, 100, 'Click and hold to power up, release to throw!', { fontSize: '24px', fill: '#000' }).setOrigin(0.5);

            this.powerMeter = this.add.rectangle(this.arm.x, this.arm.y - 50, 100, 10, 0xff0000).setOrigin(0, 0.5).setVisible(false);
            this.powerText = this.add.text(this.arm.x, this.arm.y - 70, 'Power: 0%', { fontSize: '16px', fill: '#000' }).setOrigin(0.5).setVisible(false);

            this.input.on('pointerdown', this.startPowerUp, this);
            this.input.on('pointerup', this.throwMozzarella, this);

            this.score = 0;
            this.level = 1;
            this.ferrySpeed = 0.5;
            this.wind = 0;
            this.gameState = 'playing';
            this.levelCompleting = false;
        }

        update() {
            if (this.gameState !== 'playing') return;

            this.ferry.x += this.ferrySpeed;
            this.arm.x += this.ferrySpeed;
            this.powerMeter.x += this.ferrySpeed;
            this.powerText.x += this.ferrySpeed;

            if (this.isPoweringUp) {
                this.power = Math.min(100, this.power + 2);
                this.updatePowerMeter();
            }

            if (this.mozzarella.visible) {
                this.mozzarella.x += this.wind;
                if (this.mozzarella.y > 600 || this.mozzarella.x < 0 || this.mozzarella.x > 800) {
                    this.resetMozzarella();
                }
                if (!this.levelCompleting && Phaser.Geom.Intersects.RectangleToRectangle(this.mozzarella.getBounds(), this.cousin.getBounds())) {
                    this.hitCousin();
                }
            }

            if (this.ferry.x - this.ferry.width/2 > 800) {
                this.gameOver();
            }
        }

        startPowerUp() {
            if (this.gameState !== 'playing') return;
            this.isPoweringUp = true;
            this.power = 0;
            this.powerMeter.setVisible(true);
            this.powerText.setVisible(true);
            this.arm.setFrame(1);  // Set to wind-up frame
        }

        updatePowerMeter() {
            this.powerMeter.width = this.power;
            this.powerText.setText(`Power: ${this.power}%`);
        }

        throwMozzarella() {
            if (this.gameState !== 'playing' || !this.isPoweringUp) return;

            this.isPoweringUp = false;
            this.powerMeter.setVisible(false);
            this.powerText.setVisible(false);

            this.arm.play('throw');

            this.mozzarella.setVisible(true);
            this.mozzarella.setPosition(this.arm.x, this.arm.y);
            
            let angle = Phaser.Math.Angle.Between(this.arm.x, this.arm.y, this.cousin.x, this.cousin.y);
            let throwSpeed = 300 + (this.power * 4);
            
            angle += Phaser.Math.FloatBetween(-0.2, 0.2);
            throwSpeed += Phaser.Math.FloatBetween(-50, 50);
            
            let velocityX = Math.cos(angle) * throwSpeed;
            let velocityY = Math.sin(angle) * throwSpeed - 250;
            
            this.mozzarella.setVelocity(velocityX, velocityY);

            this.time.delayedCall(300, () => {
                this.arm.setFrame(0);  // Reset to resting frame after throw
            });
        }

        hitCousin() {
            if (this.mozzarella.body.velocity.y > 0 && !this.levelCompleting) {
                this.levelCompleting = true;
                this.mozzarella.setVelocity(0, 0);
                this.score += 10;
                this.scoreText.setText('Score: ' + this.score);
                this.time.delayedCall(1000, () => {
                    this.levelComplete();
                });
            }
        }

        levelComplete() {
            this.level++;
            this.levelText.setText('Level: ' + this.level);
            
            this.ferrySpeed += 0.1;
            this.wind = Phaser.Math.Between(-3, 3);

            this.resetPositions();
            this.levelCompleting = false;

            // Display "Level Complete" message
            let levelCompleteText = this.add.text(400, 300, 'Level Complete!', { fontSize: '48px', fill: '#000' }).setOrigin(0.5);
            this.time.delayedCall(2000, () => {
                levelCompleteText.destroy();
            });
        }

        resetPositions() {
            this.ferry.x = 200;
            this.arm.x = this.ferry.x - this.ferry.width/2 + 50;
            this.powerMeter.x = this.arm.x;
            this.powerText.x = this.arm.x;
            this.cousin.x = Math.min(100 + (this.level * 15), 650);
            this.resetMozzarella();
        }

        resetMozzarella() {
            this.mozzarella.setVisible(false);
            this.mozzarella.setPosition(this.arm.x, this.arm.y);
            this.mozzarella.setVelocity(0, 0);
        }

        gameOver() {
            this.gameState = 'gameOver';
            this.add.text(400, 300, 'Game Over', { fontSize: '64px', fill: '#000' }).setOrigin(0.5);
            this.time.delayedCall(3000, () => {
                this.scene.restart();
            });
        }
    }

    const config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        physics: {
            default: 'arcade',
            arcade: { gravity: { y: 300 }, debug: false }
        },
        scene: GameScene
    };

    new Phaser.Game(config);
    </script>
</body>
</html>
